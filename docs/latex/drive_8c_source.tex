\subsection{drive.\+c}
\label{drive_8c_source}\index{src/drive.\+c@{src/drive.\+c}}

\begin{DoxyCode}
00001 \textcolor{preprocessor}{#include "drive.h"}
00002 \textcolor{preprocessor}{#include "controller.h"}
00003 \textcolor{preprocessor}{#include "log.h"}
00004 \textcolor{preprocessor}{#include "motor_ports.h"}
00005 \textcolor{preprocessor}{#include "slew.h"}
00006 \textcolor{preprocessor}{#include "vmath.h"}
00007 \textcolor{preprocessor}{#include <API.h>}
00008 
00009 \textcolor{keyword}{static} \textcolor{keywordtype}{int} thresh = 30;
00010 
00015 \textcolor{keywordtype}{int} getThresh() \{ \textcolor{keywordflow}{return} thresh; \}
00016 
00021 \textcolor{keywordtype}{void} setThresh(\textcolor{keywordtype}{int} t) \{ thresh = t; \}
00022 
00028 \textcolor{keywordtype}{void} update_drive_motors() \{
00029   \textcolor{comment}{// Get the joystick values from the controller}
00030   \textcolor{keywordtype}{int} x = 0;
00031   \textcolor{keywordtype}{int} y = 0;
00032   \textcolor{keywordflow}{if} (get_mode() == PARTNER_CONTROLLER_MODE) \{
00033     x = (joystickGetAnalog(PARTNER, 3));
00034     y = (joystickGetAnalog(PARTNER, 1));
00035   \} \textcolor{keywordflow}{else} \{
00036     x = -(joystickGetAnalog(MASTER, 3));
00037     y = (joystickGetAnalog(MASTER, 1));
00038   \}
00039   \textcolor{comment}{// Make sure the joystick values are significant enough to change the motors}
00040   \textcolor{keywordflow}{if} (x < thresh && x > -thresh) \{
00041     x = 0;
00042   \}
00043   \textcolor{keywordflow}{if} (y < thresh && y > -thresh) \{
00044     y = 0;
00045   \}
00046   \textcolor{comment}{// Create motor values for the left and right from the x and y of the joystick}
00047   \textcolor{keywordtype}{int} r = (x + y);
00048   \textcolor{keywordtype}{int} l = -(x - y);
00049 
00050   \textcolor{comment}{// Set the drive motors}
00051   set_side_speed(LEFT, l);
00052   set_side_speed(RIGHT, -r);
00053 \}
00054 
00062 \textcolor{keywordtype}{void} set_side_speed(side_t side, \textcolor{keywordtype}{int} speed) \{
00063   \textcolor{keywordflow}{if} (side == RIGHT || side == BOTH) \{
00064     set_motor_slew(MOTOR_BACK_RIGHT, -speed);
00065     set_motor_slew(MOTOR_FRONT_RIGHT, -speed);
00066     set_motor_slew(MOTOR_MIDDLE_RIGHT, -speed);
00067   \}
00068   \textcolor{keywordflow}{if} (side == LEFT || side == BOTH) \{
00069     set_motor_slew(MOTOR_BACK_LEFT, speed);
00070     set_motor_slew(MOTOR_MIDDLE_LEFT, speed);
00071     set_motor_slew(MOTOR_FRONT_LEFT, speed);
00072   \}
00073 \}
00074 
00081 \textcolor{keyword}{static} \textcolor{keywordtype}{float} joystickExp(\textcolor{keywordtype}{int} joystickVal) \{
00082   \textcolor{comment}{// make the offset negative if moving backwards}
00083   \textcolor{keywordflow}{if} (abs(joystickVal) < THRESHOLD) \{
00084     \textcolor{keywordflow}{return} 0;
00085   \}
00086 
00087   \textcolor{keywordtype}{int} offset;
00088   \textcolor{comment}{// Use the threshold to ensure the joystick values are significant}
00089   \textcolor{keywordflow}{if} (joystickVal < 0) \{
00090     offset = -(THRESHOLD);
00091   \} \textcolor{keywordflow}{else} \{
00092     offset = THRESHOLD;
00093   \}
00094   \textcolor{comment}{// Apply the function ((((x/10)^3)/18) + offset) * 0.8 to the joystick value}
00095   \textcolor{keywordflow}{return} (pow(joystickVal / 10, 3) / 18 + offset) * 0.8;
00096 \}
\end{DoxyCode}
